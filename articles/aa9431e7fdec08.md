---
title: "ã€Terraformã€‘EC2ã®ä½œæˆï¼ˆAMIã®æ¤œç´¢ã€å–å¾—ï¼‰"
emoji: "ğŸ“"
type: "tech"
topics:
  - "aws"
  - "ec2"
  - "terraform"
published: true
published_at: "2025-01-14 21:37"
---

### ã¯ã˜ã‚ã«
ä¸‹è¨˜ã®EC2ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
EC2ã®æœ€æ–°ç‰ˆã®AMIã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•çš„ã«å–å¾—ã§ãã‚‹ã‚ˆã†ã«`aws_ami`ã‚’ä½¿ç”¨ã—ã¦ã„ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/b3b722439bf6-20250113.png)

- AMIã®æ¤œç´¢ã€aws_amiã§å–å¾—
- ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ
- EC2ã®æ§‹ç¯‰

## AMIã®æ¤œç´¢
ä»Šå›ã¯`Amazon Linux 2 AMI (HVM) - Kernel 5.10, SSD Volume Type`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
AWS CLIã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€‚
https://docs.aws.amazon.com/cli/latest/reference/ec2/describe-images.html
```
#AMI IDã¯ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã€‚
$ aws ec2 describe-images --image-ids AMI ID
```
`RootDeviceType`ã‚„`VirtualizationType`ã‚’å‚ç…§ã—ã¦ã„ãã€‚

### aws_ami
1. owners : enum[] : æ‰€æœ‰è€…ã€‚self,amazon,aws-marketplace,microsoft
2. most_recent : bool : æœ€æ–°ã®ã‚‚ã®ã‚’é¸æŠã™ã‚‹ã‹ã©ã†ã‹
3. executable_users : string[] : å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‚selfã¾ãŸã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
4. filter : block : name,valuesã®å€¤ã‚’è¨­å®šã€‚

```HCL:data.tf
data "aws_ami" "app" {
  most_recent = true
  owners      = ["self", "amazon"]

  filter {
    name   = "name"
    values = ["amzn2-ami-kernel-5.10-hvm-2.0.*.0-x86_64-gp2"]
  }

  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}
```

## ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ
é€šå¸¸ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆã™ã‚‹æ™‚ã¯ã€AWSå´ã«å…¬é–‹éµãŒä¿å­˜ã•ã‚Œã¾ã™ãŒã€
Terraformã®å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã§`ssh-keygen`ã‚’ä½¿ç”¨ã—ã€ç§˜å¯†éµãƒ»å…¬é–‹éµã‚’ä½œæˆã—ã€AWSã«å…¬é–‹éµã‚’ç™»éŒ²ã—ã¾ã™ã€‚
### key-gen
- å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§`ssh-keygen`ã‚’å®Ÿè¡Œã€‚
- srcã«ç§»å‹•ã•ã›ã€ç§˜å¯†éµã«ã¯.pemã§ä¿å­˜ã€‚

### aws_keypair
1. key_name : string : ã‚­ãƒ¼ãƒšã‚¢å
2. public_key : string : å…¬é–‹éµ
3. tags : object : ã‚¿ã‚°
```HCL:appserver.tf
#------------------
#key pair
#------------------
resource "aws_key_pair" "keypair" {
  key_name   = "${var.project}-${var.environment}-keypair"
  public_key = file("./src/udemy_terraform-dev-keypair.pub")

  tags = {
    Name    = "${var.project}-${var.environment}-keypair"
    Project = var.project
    Env     = var.environment
  }
}
```

## EC2ã®ä½œæˆ
### aws_instanceï¼ˆåŸºæœ¬è¨­å®šï¼‰
1. ami : string : AMI ID
2. instance_type : enum : ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—
3. tags : object : ã‚¿ã‚°
### aws_instanceï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
1. string_id : string : ã‚µãƒ–ãƒãƒƒãƒˆID
2. associate_public_ip_address : bool : è‡ªå‹•å‰²ã‚Šå½“ã¦ãƒ‘ãƒ–ãƒªãƒƒã‚¯ID
3. vpc_security_group_ids : string[] : ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID
### aws_instanceï¼ˆãã®ä»–ï¼‰
1. iam_instance_profile : string : IAMãƒ­ãƒ¼ãƒ«
2. key_name : string : ã‚­ãƒ¼ãƒšã‚¢å
3. user_data : string : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
```HCL:appserver.tf
#------------------
#EC2 Instance
#------------------
resource "aws_instance" "app_server" {
  #åŸºæœ¬è¨­å®š
  ami           = data.aws_ami.app.id
  instance_type = "t2.micro"
  #ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
  subnet_id                   = aws_subnet.public_subnet_1a.id
  associate_public_ip_address = true
  vpc_security_group_ids      = [aws_security_group.app_sg.id, aws_security_group.opmng_sg.id]
  #ãã®ä»–
  key_name = aws_key_pair.keypair.key_name

  tags = {
    Name    = "${var.project}-${var.environment}-app-ec2"
    Project = var.project
    Env     = var.environment
    Type    = "app"
  }

}
```