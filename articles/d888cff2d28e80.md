---
title: "ã€Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ãƒ»Next.jsã€‘å®‰å…¨ã«Cognitoèªè¨¼ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ™"
type: "tech"
topics:
  - "aws"
  - "cognito"
  - "èªè¨¼"
  - "nextjs"
  - "amplify"
published: true
published_at: "2025-08-15 12:25"
---

# ã¯ã˜ã‚ã«
Cognitoãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ä½œæˆæ–¹æ³•ã¯ã€ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚
ãã®ä¸­ã§ã‚‚Amplify Authã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ã‚’ã„ãã¤ã‹è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¾ãŸã€Next.jsã‚’ä½¿ç”¨ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã‚‚é…æ…®ã—ãŸå®Ÿè£…ã‚‚è¡Œã£ã¦ã„ã¾ã™ã®ã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚


# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç´¹ä»‹
### amazon-cognito-identity-js
**æ¦‚è¦**
Cognito User Pool å°‚ç”¨ã®æ—§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‘ã‘JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒª
SRPèªè¨¼ã‚’ç›´æ¥æ‰±ãˆã‚‹
**ç‰¹å¾´**
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§SRPèªè¨¼ã‚’è¡Œãˆã‚‹
ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ™ãƒ¼ã‚¹APIãŒå¤šã„
Amplify Authã®å†…éƒ¨ã§ä½¿ã‚ã‚Œã¦ã„ãŸ
æ–°è¦é–‹ç™ºã§ã¯éæ¨å¥¨æ°—å‘³ï¼ˆAmplify Auth æ¨å¥¨ï¼‰
**ç”¨é€”**
æ—§SPAã‚„ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰ã§SRPèªè¨¼ã‚’ç›´æ¥å®Ÿè£…ã—ãŸã„å ´åˆ
Amplify ã‚’ä½¿ã„ãŸããªã„ãŒSRPã‚’ä½¿ã„ãŸã„å ´åˆ

### @aws-sdk/client-cognito-identity-providerï¼ˆSDK v3ï¼‰
**æ¦‚è¦**
AWS SDK for JavaScript v3 ã®ä¸€éƒ¨
Cognito User Pool ã® API ã‚’ä½ãƒ¬ãƒ™ãƒ«ã§å‘¼ã¶ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
SRPã®è¨ˆç®—ã¯è‡ªåˆ†ã§è¡Œã†å¿…è¦ã‚ã‚Š
**ç‰¹å¾´**
Promiseãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒ€ãƒ³SDK
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆAdminç³»æ“ä½œï¼‰ã«æœ€é©
ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚‚å‘¼ã¹ã‚‹ãŒã€SRPã‚„ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã¯è‡ªå‰ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½ã§è»½é‡
**ç”¨é€”**
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ»å‰Šé™¤ãƒ»å±æ€§æ›´æ–°
ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆLambdaé€£æºï¼‰
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„çµ±åˆã‚·ã‚¹ãƒ†ãƒ 


### Amplify Auth
**æ¦‚è¦**
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactã€Next.jsã€ãƒ¢ãƒã‚¤ãƒ«ãªã©ï¼‰å‘ã‘ã«é«˜ãƒ¬ãƒ™ãƒ«ã§Cognitoèªè¨¼ã‚’ç°¡å˜ã«ä½¿ãˆã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
å†…éƒ¨çš„ã«ã¯ amazon-cognito-identity-js ã‚„ AWS SDK ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚
**ç‰¹å¾´**
ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ»ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ»MFAãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ»SRPèªè¨¼ã‚’è‡ªå‹•ã§å‡¦ç†
TypeScriptå¯¾å¿œã€Promiseãƒ™ãƒ¼ã‚¹
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºè€…ãŒã€Œã»ã¼è¨­å®šã ã‘ã€ã§ä½¿ãˆã‚‹
Hosted UI ã®åˆ©ç”¨ã‚‚å¯èƒ½
SRPèªè¨¼ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹
**ç”¨é€”**
SPAã‚„ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
é–‹ç™ºé€Ÿåº¦å„ªå…ˆã§ã‚»ã‚­ãƒ¥ã‚¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’çµ„ã¿ãŸã„å ´åˆ

### Amplify Auth ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã—ã¦
### ãƒˆãƒ¼ã‚¯ãƒ³ä¿ç®¡å…ˆã«ã¤ã„ã¦
**Amplify Auth**ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ä¿ç®¡å…ˆã¨ã—ã¦`Local Storage`ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
Next.jsã§ã¯`Amplify.configure(amplifyConfig, { ssr: true })`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§`Cookie`ã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãŸã ã€`Local Storage`ã¨`Cookie`ã®ã©ã¡ã‚‰ã§ã‚ã£ã¦ã‚‚ã€XSSå¯¾ç­–ãŒé‡è¦ã§ã™ã€‚
https://www.docswell.com/s/ockeghem/ZM6VNK-phpconf2021-spa-security#p90
https://qiita.com/asw_hoggge/items/cac11b0d9b96c2bfc222
https://www.shadan-kun.com/waf_websecurity/xss/
https://zenn.dev/zuma_lab/articles/74a999aa1a8c59

Next.jsã§ã¯`middleware`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§`HttpOnly Cookie`ã‚’ä½¿ç”¨ã—ã¦èªè¨¼ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã€ŒHttpOnlyã€å±æ€§ã‚’è¨­å®šã•ã‚ŒãŸCookieã«ã¯ã€HTMLå†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã€ä»®ã«ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°æ”»æ’ƒã‚’å—ã‘ãŸã¨ã—ã¦ã‚‚ã€JavaScriptã«ã‚ˆã‚‹Cookieæƒ…å ±ã®ç›—ã¿å‡ºã—ã‚’é˜²æ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
https://www.aeyescan.jp/blog/cross-site-scripting/#toc12
https://zenn.dev/mabo23/articles/e4b980e61a0d47

**â– middlewareãƒ»API Routesã¨ã¯**
Middleware ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«å±Šã„ã¦ã‹ã‚‰ã€Next.js ãŒãƒšãƒ¼ã‚¸ã‚„ API ãƒ«ãƒ¼ãƒˆã‚’å‡¦ç†ã™ã‚‹ç›´å‰ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚
ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¤œæŸ»ã—ã€å¿…è¦ã«å¿œã˜ã¦å†…å®¹ã‚’æ›¸ãæ›ãˆãŸã‚Šã€åˆ¥ã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãŸã‚Šã¨ã„ã£ãŸå‡¦ç†ã‚’å·®ã—è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
https://zenn.dev/cloud_ace/articles/a30c75dbe220f3
https://qiita.com/GleapPost/items/0b5c4e7425adfdbfaed6

### ç’°å¢ƒå¤‰æ•°ã«ã¤ã„ã¦
Next.jsã§ã¯ã€`NEXT_PUBLIC_`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Clientå´ã§ã‚‚Serverå´ã§ã‚‚èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
`amazon-cognito-identity-js`ã‚„`Amplify Auth`ã§ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§èªè¨¼ã™ã‚‹å ´åˆã¯ã€ã“ã®ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ãŸã ã€ã“ã®ç’°å¢ƒå¤‰æ•°ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«é€ä¿¡ã•ã‚Œã‚‹JavaScriptã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã¾ã™ã€‚
ã“ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€æ§˜ã€…ãªNEXT_PUBLIC_ç’°å¢ƒã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰æ™‚ã«è¨­å®šã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
æ¬¡ã®ã‚ˆã†ã«å¤‰æ•°ã‚’åˆ©ç”¨ã—ãŸå ´åˆã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œã¾ã›ã‚“ã€‚
```js
// å¤‰æ•°ã‚’ä½¿ç”¨ã—ãŸæŒ‡å®šã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œãªã„
const varName = 'NEXT_PUBLIC_ANALYTICS_ID'
setupAnalyticsService(process.env[varName])

// å¤‰æ•°ã‚’ä½¿ç”¨ã—ãŸæŒ‡å®šã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã•ã‚Œãªã„
const env = process.env
setupAnalyticsService(env.NEXT_PUBLIC_ANALYTICS_ID)
```
https://zenn.dev/hisayuki_mori/articles/environment-variables-for-nextjs

ãã‚‚ãã‚‚`NEXT_PUBLIC_`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ã¤ã‘ãšã«`middleware`ã¨`API Routes`ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç’°å¢ƒå¤‰æ•°ã‚’å‡¦ç†ã™ã‚‹å®Ÿè£…ã‚‚å¯èƒ½ã§ã™ã€‚

# Cognitoå´ã®è¨­å®š
ã“ã“ã‹ã‚‰ã¯ã€Cognitoã®è¨­å®šã«å…¥ã‚Šã¾ã™ã€‚

### ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…
**ã‚µã‚¤ãƒ³ã‚¤ãƒ³**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

![](/images/d888cff2d28e80/image-1.png)

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
ã“ã‚Œã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§IDã¨ã—ã¦å…¥åŠ›ã§ãã‚‹ã‚‚ã®ã¯ä½•ã‹ã‚’æ±ºã‚ã‚‹è¨­å®šã§ã™ã€‚
å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ„å‘³
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹: user@example.comï¼‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ï¼ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¨ã„ã†æ§‹æˆã«ãªã‚Šã¾ã™ã€‚
- é›»è©±ç•ªå·
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«é›»è©±ç•ªå·ï¼ˆä¾‹: +819012345678ï¼‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ï¼ é›»è©±ç•ªå·ã€ã¨ã„ã†æ§‹æˆã«ãªã‚Šã¾ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„é›»è©±ç•ªå·ã¨ã¯åˆ¥ã«ã€è‡ªåˆ†ã§å¥½ããªãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä¾‹: taro_yamada123ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã¯ã€ã“ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¾ã™ã€‚

:::message
Cognitoã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»é›»è©±ç•ªå·ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«å…¨ä½“ã§ä¸€æ„ã«ãªã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§é¸ã‚“ã é …ç›®ã«ã¤ã„ã¦ã¯ã€**åŒã˜å€¤ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¤‡æ•°ä½œã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚**
:::

### ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚ã®å¿…é ˆå±æ€§
ã“ã‚Œã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ–°è¦ä½œæˆï¼ˆã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼‰ã™ã‚‹ã¨ãã«ã€å¿…ãšå…¥åŠ›ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„é …ç›®ã¯ä½•ã‹ã‚’æ±ºã‚ã‚‹è¨­å®šã§ã™ã€‚
ã“ã“ã§é¸æŠã—ãŸå±æ€§ï¼ˆä¾‹: email, phone_number, given_nameï¼ˆåï¼‰ãªã©ï¼‰ã¯ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ã§å¿…é ˆå…¥åŠ›é …ç›®ã«ãªã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã€Œemailã€ã‚’å¿…é ˆå±æ€§ã«ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¿…ãšå…¥åŠ›ã—ãªã„ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã§ãã¾ã›ã‚“ã€‚

https://dev.classmethod.jp/articles/study-tokens-of-cognito-user-pools/

### èªè¨¼ãƒ•ãƒ­ãƒ¼
![](/images/d888cff2d28e80/image-2.png)

| ãƒ•ãƒ­ãƒ¼å | ä½¿ã„æ–¹ | ç‰¹å¾´ |
| ---- | ---- | ---- |
| ALLOW_USER_AUTHï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ³ï¼‰ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ã®èªè¨¼æ–¹å¼ã‹ã‚‰é¸æŠã§ãã‚‹ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€OTPã€ç”Ÿä½“èªè¨¼ã€MFAãªã©ï¼‰ | è¤‡æ•°ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ‰‹æ®µã‚’è¨±å¯ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒUIã§é¸ã¶ |
| ALLOW_USER_PASSWORD_AUTH | ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›´æ¥é€ä¿¡ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ | å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã ãŒã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç›´æ¥é€ã‚‰ã‚Œã‚‹ãŸã‚TLSå¿…é ˆ |
| ALLOW_USER_SRP_AUTHï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ³ï¼‰ | SRPï¼ˆSecure Remote Passwordï¼‰ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›´æ¥é€ã‚‰ãšã«å®‰å…¨ã«æ¤œè¨¼ã§ãã‚‹ã€‚AWSæ¨å¥¨ã€‚ |
| ALLOW_ADMIN_USER_PASSWORD_AUTH | ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ | Admin APIã§ã®ã¿ä½¿ãˆã‚‹ã€‚Hosted UIã§ã¯ä¸å¯ |
| ALLOW_CUSTOM_AUTH | Lambdaãƒˆãƒªã‚¬ãƒ¼ã§ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œã‚‹ | ç‹¬è‡ªã®OTPã€å¤–éƒ¨IdPã€ç§˜å¯†è³ªå•ãªã©ã‚’çµ„ã¿è¾¼ã‚ã‚‹ |
| ALLOW_REFRESH_TOKEN_AUTHï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ³ï¼‰ | Refresh Tokenã‚’ä½¿ã£ã¦æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾— | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãªã—ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°å¯èƒ½ |

â€»`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ³`ã¨ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã§ **ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (SPA)** ã‚’é¸æŠã—ãŸã¨ãã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

### SRPï¼ˆSecure Remote Passwordï¼‰æ–¹å¼ã¨ã¯
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§ç›´æ¥é€ã‚‰ãªã„
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨Cognitoé–“ã§æš—å·å­¦çš„ãªã‚„ã‚Šå–ã‚Šã‚’ã—ã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ¼ã‚Œã«ãã„
- AWSå…¬å¼ã§ã¯SRPã‚’æ¨å¥¨ï¼ˆALLOW_USER_SRP_AUTHï¼‰

https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/amazon-cognito-user-pools-authentication-flow-methods.html
https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-security-best-practices.html?utm_source=chatgpt.com

# ç’°å¢ƒå¤‰æ•°
```:.env.local
# AWS Cognitoè¨­å®š
NEXT_PUBLIC_USER_POOL_ID=ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ« ID
NEXT_PUBLIC_CLIENT_ID=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID

# AWS Cognitoè¨­å®šï¼ˆmiddleware,API Routesä½¿ç”¨æ™‚ï¼‰
USER_POOL_ID=ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ« ID
CLIENT_ID=ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID
AWS_REGION=ap-northeast-1
```

# amazon-cognito-identity-js ã®å®Ÿè£…ä¾‹
```
npm install amazon-cognito-identity-js
###ãƒãƒ¼ã‚¸ãƒ§ãƒ³###
amazon-cognito-identity-js: 6.3.15
```
```
client-ver/
â””â”€â”€ src/
    â””â”€â”€ app/
        â”œâ”€â”€ components/
        â”‚   â”œâ”€â”€ AuthWrapper.tsx      # èªè¨¼ãƒã‚§ãƒƒã‚¯ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        â”‚   â”œâ”€â”€ LogoutButton.tsx      # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        â”‚   â””â”€â”€ UserInfo.tsx          # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        â”‚
        â”œâ”€â”€ login/
        â”‚   â””â”€â”€ page.tsx              # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
        â”‚
        â”œâ”€â”€ signup/
        â”‚   â””â”€â”€ page.tsx              # ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦ç™»éŒ²ï¼‰ãƒšãƒ¼ã‚¸
        â”‚
        â”œâ”€â”€ globals.css               # ã‚°ãƒ­ãƒ¼ãƒãƒ«CSSï¼ˆTailwindè¨­å®šå«ã‚€ï¼‰
        â”œâ”€â”€ layout.tsx                # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
        â””â”€â”€ page.tsx                  # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
```
```
//èªè¨¼ãƒ•ãƒ­ãƒ¼å›³
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
         â†“
    Cognitoèªè¨¼
         â†“
    ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
         â†“
  localStorageä¿å­˜
         â†“
    TOPãƒšãƒ¼ã‚¸ã¸
         â†“
  AuthWrapperã§ä¿è­·
```

**1. èªè¨¼ãƒ©ãƒƒãƒ‘ãƒ¼**
```ts:AuthWrapper.tsx
// å…¨ãƒšãƒ¼ã‚¸ã§èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
useEffect(() => {
  const idToken = localStorage.getItem('idToken')
  if (!idToken) {
    router.push('/login')
  }
}, [router])
```
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦å®Ÿè£…
- localStorageã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
- æœªèªè¨¼ã®å ´åˆã¯è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**2. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸**
```ts:login/page.tsx
cognitoUser.authenticateUser(authenticationDetails, {
  onSuccess: (result: CognitoUserSession) => {
    // 3ã¤ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
    localStorage.setItem('idToken', result.getIdToken().getJwtToken())
    localStorage.setItem('accessToken', result.getAccessToken().getJwtToken())
    localStorage.setItem('username', username)
    router.push('/')
  }
})
```
- IDãƒˆãƒ¼ã‚¯ãƒ³ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å«ã‚€JWT
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ - APIã‚¢ã‚¯ã‚»ã‚¹ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å - è¡¨ç¤ºç”¨

**3. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸**
```ts:signup/page.tsx
userPool.signUp(username, password, attributeList, [], callback)
```
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²
- ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯

**4. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½**
```ts:LogoutButton.tsx
const handleLogout = () => {
  const cognitoUser = userPool.getCurrentUser()
  if (cognitoUser) {
    cognitoUser.signOut()  // Cognitoã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
  }
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
  localStorage.removeItem('idToken')
  localStorage.removeItem('accessToken')
  localStorage.removeItem('username')
  router.push('/login')
}
```

# Amplify Auth ã®å®Ÿè£…ä¾‹
```
npm install aws-amplify
###ãƒãƒ¼ã‚¸ãƒ§ãƒ³###
aws-amplify: 6.15.5
```
```
client-ver-amplifyauth/
â””â”€â”€ src/
    â””â”€â”€ app/
        â”œâ”€â”€ components/
        â”‚   â”œâ”€â”€ AmplifyProvider.tsx  # Amplifyè¨­å®šãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
        â”‚   â”œâ”€â”€ AuthWrapper.tsx       # èªè¨¼ãƒã‚§ãƒƒã‚¯ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        â”‚   â”œâ”€â”€ LogoutButton.tsx      # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        â”‚   â””â”€â”€ UserInfo.tsx          # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        â”‚
        â”œâ”€â”€ lib/
        â”‚   â””â”€â”€ amplifyConfig.ts      # Amplifyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
        â”‚
        â”œâ”€â”€ login/
        â”‚   â””â”€â”€ page.tsx              # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
        â”‚
        â”œâ”€â”€ signup/
        â”‚   â””â”€â”€ page.tsx              # ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦ç™»éŒ²ï¼‰ãƒšãƒ¼ã‚¸
        â”‚
        â”œâ”€â”€ globals.css               # ã‚°ãƒ­ãƒ¼ãƒãƒ«CSSï¼ˆTailwindè¨­å®šå«ã‚€ï¼‰
        â”œâ”€â”€ layout.tsx                # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
        â””â”€â”€ page.tsx                  # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
```
```
//èªè¨¼ãƒ•ãƒ­ãƒ¼å›³
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Amplify Auth â†’ è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç† â†’ ã‚»ã‚­ãƒ¥ã‚¢ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
                â†“
          è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                â†“
          ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒ
```

**1. Amplifyè¨­å®š**
```ts:amplifyConfig.ts
export const amplifyConfig = {
  Auth: {
    Cognito: {
      userPoolId: process.env.NEXT_PUBLIC_USER_POOL_ID!,
      userPoolClientId: process.env.NEXT_PUBLIC_CLIENT_ID!,
      signUpVerificationMethod: 'code' as const,
      loginWith: {
        username: true,
        email: false
      }
    }
  }
}
```

**2. AmplifyProvider**
```ts:AmplifyProvider.tsx
export default function AmplifyProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    Amplify.configure(amplifyConfig, { ssr: true })
  }, [])
  return <>{children}</>
}
```
- Amplifyã®åˆæœŸåŒ–ã‚’ä¸€å…ƒç®¡ç†
- SSRã‚µãƒãƒ¼ãƒˆã®æœ‰åŠ¹åŒ–
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ©ãƒƒãƒ—

**3. èªè¨¼ãƒã‚§ãƒƒã‚¯**
```ts:AuthWrapper.tsx
// å®Ÿéš›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼
try {
  await getCurrentUser()  // Cognitoã¨é€šä¿¡ã—ã¦æ¤œè¨¼
} catch {
  router.push('/login')
}
```
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’è‡ªå‹•ãƒã‚§ãƒƒã‚¯

**4. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†**
```ts:login/page.tsx
const { isSignedIn } = await signIn({ username, password })
if (isSignedIn) {
  localStorage.setItem('username', username)  // è¡¨ç¤ºç”¨ã®ã¿ä¿å­˜
  router.push('/')
}
```
- ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ãŒè‡ªå‹•åŒ–

**5. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†**
```ts:signup/page.tsx
// ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
await signUp({
  username,
  password,
  options: {
    userAttributes: { email }
  }
})

// ã‚¹ãƒ†ãƒƒãƒ—2: ç¢ºèª
await confirmSignUp({
  username,
  confirmationCode: verificationCode
})
```

**6. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½**
```ts:LogoutButton.tsx
  const handleLogout = async () => {
    try {
      await signOut()
      localStorage.removeItem('username')
      router.push('/login')
    } catch (error) {
      console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error)
    }
  }
```

# Amplify Auth ã®å®Ÿè£…ä¾‹ï¼ˆAmplify Authãƒ»middlewareãƒ»API Routessï¼‰
- ç’°å¢ƒå¤‰æ•°ã«`NEXT_PUBLIC_`ã‚’ä½¿ç”¨ã—ãªã„
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ã¯`middleware`å®Ÿè£…
- èªè¨¼ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ


```
npm install aws-amplify
###ãƒãƒ¼ã‚¸ãƒ§ãƒ³###
aws-amplify: 6.15.5
```
```
client-amplify-auth-apiroute/
â””â”€â”€ src/
    â”œâ”€â”€ app/
    â”‚   â”œâ”€â”€ api/
    â”‚   â”‚   â””â”€â”€ config/
    â”‚   â”‚       â””â”€â”€ route.ts         # Amplifyè¨­å®šã‚’è¿”ã™APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    â”‚   â”‚
    â”‚   â”œâ”€â”€ components/
    â”‚   â”‚   â”œâ”€â”€ AmplifyProvider.tsx  # Amplifyè¨­å®šãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆAPIçµŒç”±ã§è¨­å®šå–å¾—ï¼‰
    â”‚   â”‚   â”œâ”€â”€ LogoutButton.tsx     # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    â”‚   â”‚   â””â”€â”€ UserInfo.tsx         # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    â”‚   â”‚
    â”‚   â”œâ”€â”€ login/
    â”‚   â”‚   â””â”€â”€ page.tsx              # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
    â”‚   â”‚
    â”‚   â”œâ”€â”€ signup/
    â”‚   â”‚   â””â”€â”€ page.tsx              # ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦ç™»éŒ²ï¼‰ãƒšãƒ¼ã‚¸
    â”‚   â”‚
    â”‚   â”œâ”€â”€ globals.css               # ã‚°ãƒ­ãƒ¼ãƒãƒ«CSSï¼ˆTailwindè¨­å®šå«ã‚€ï¼‰
    â”‚   â”œâ”€â”€ layout.tsx                # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    â”‚   â””â”€â”€ page.tsx                  # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼‰
    â”‚
    â””â”€â”€ middleware.ts                 # èªè¨¼ãƒã‚§ãƒƒã‚¯ç”¨ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
```
```
//èªè¨¼ãƒ•ãƒ­ãƒ¼å›³
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Amplify Auth â†’ è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç† â†’ Cookieä¿å­˜
                â†“
          è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                â†“
          ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒ

//èªè¨¼ãƒã‚§ãƒƒã‚¯
ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ â†’ Middleware â†’ Cookieç¢ºèª â†’ ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯/æ‹’å¦
```

**1. ç’°å¢ƒå¤‰æ•°ã®ä¿è­·**
```ts:api/config/route.ts
// api/config/route.ts
export async function GET() {
  const config = {
    Auth: {
      Cognito: {
        userPoolId: process.env.USER_POOL_ID!,      // NEXT_PUBLIC_ä¸è¦
        userPoolClientId: process.env.CLIENT_ID!,   // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿
        region: process.env.AWS_REGION!
      }
    }
  }
  return NextResponse.json(config)
}
```
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ«ã«ç’°å¢ƒå¤‰æ•°ãŒå«ã¾ã‚Œãªã„
- .env.localã®å†…å®¹ãŒéœ²å‡ºã—ãªã„

**2. Middleware ã«ã‚ˆã‚‹èªè¨¼åˆ¶å¾¡**
```ts:middleware.ts
export function middleware(request: NextRequest) {
  // AmplifyãŒä¿å­˜ã™ã‚‹Cookieã®å½¢å¼ã‚’ç†è§£ã—ã¦ã„ã‚‹
  const clientId = process.env.CLIENT_ID
  const lastAuthUser = request.cookies.get(
    `CognitoIdentityServiceProvider.${clientId}.LastAuthUser`
  )
  const idToken = request.cookies.get(
    `CognitoIdentityServiceProvider.${clientId}.${lastAuthUser?.value}.idToken`
  )

  if (!idToken) {
    // æœªèªè¨¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
    const loginUrl = new URL('/login', request.url)
    loginUrl.searchParams.set('from', pathname)
    return NextResponse.redirect(loginUrl)
  }
}
```

**3. AmplifyProvider ã®å‹•çš„è¨­å®š**
```ts:AmplifyProvider.tsx
// AmplifyProvider.tsx
useEffect(() => {
  const configureAmplify = async () => {
    // 1. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¨­å®šã‚’å–å¾—
    const response = await fetch('/api/config')
    const config = await response.json()
    
    // 2. Amplifyã‚’è¨­å®šï¼ˆSSRãƒ¢ãƒ¼ãƒ‰ï¼‰
    Amplify.configure(config, { ssr: true })
  }
}, [])
```

**4. ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼**
```ts:login/page.tsx
// login/page.tsx
const handleLogin = async () => {
  // 1. Amplifyèªè¨¼
  const { isSignedIn } = await signIn({ username, password })
  
  if (isSignedIn) {
    // 2. AmplifyãŒè‡ªå‹•çš„ã«Cookieã«ä¿å­˜ï¼ˆssr: true ã®åŠ¹æœï¼‰
    
    // 3. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    router.push(from)
    router.refresh() // Middlewareã«èªè¨¼çŠ¶æ…‹ã‚’åæ˜ 
  }
}
```

# ãŠã‚ã‚Šã«
Cognitoãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã¨Next.jsã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å®‰å…¨ã‹ã¤æŸ”è»Ÿãªãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
ä»Šå›ç´¹ä»‹ã—ãŸSRPèªè¨¼ã€Amplify Authã€middlewareã‚’ç”¨ã„ãŸã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰èªè¨¼ãªã©ã‚’ç†è§£ã—ã€ã‚»ã‚­ãƒ¥ã‚¢ãªSPAã‚„Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚