---
title: "ã€Terraformã€‘IAMãƒãƒªã‚·ãƒ¼ã€IAMã‚°ãƒ«ãƒ¼ãƒ—ã€IAMãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆ"
emoji: "ğŸŒŸ"
type: "tech"
topics:
  - "aws"
  - "terraform"
  - "iam"
published: true
published_at: "2025-01-14 23:22"
---

## ã¯ã˜ã‚ã«
Terraformã§IAMãƒãƒªã‚·ãƒ¼ã¨IAMã‚°ãƒ«ãƒ¼ãƒ—ã€IAMãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
.
â”œâ”€â”€ cert
â”‚   â””â”€â”€ master.public.gpg
â”œâ”€â”€ iam_group.tf
â”œâ”€â”€ iam_policy.tf
â”œâ”€â”€ iam_user.tf
â”œâ”€â”€ main.tf
â””â”€â”€ terraform.tfvars
```

## IAMãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
ä»¥ä¸‹ã®3ã¤ã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
- ãƒ“ãƒªãƒ³ã‚°ã‚’å…¨ã¦æ‹’å¦ : `aws-portal:*`
- EC2ã®å†èµ·å‹•ã‚’è¨±å¯ : `ec2:RebootInstances`
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚’è¨±å¯ : `iam:ChangePassword`
```HCL:iam_policy.tf
# ---------------------------------------------
# IAM Policy
# ---------------------------------------------
resource "aws_iam_policy" "billing_deny" {
  name        = "${var.project}-${var.environment}-billing-deny-iam-policy"
  description = "Blling deny policy"
  policy      = data.aws_iam_policy_document.billing_deny.json
}

data "aws_iam_policy_document" "billing_deny" {
  statement {
    effect    = "Deny"
    actions   = ["aws-portal:*"]
    resources = ["*"]
  }
}

resource "aws_iam_policy" "ec2_rebootable" {
  name        = "${var.project}-${var.environment}-ec2-rebootable-iam-policy"
  description = "EC2 rebootable policy"
  policy      = data.aws_iam_policy_document.ec2_rebootable.json
}

data "aws_iam_policy_document" "ec2_rebootable" {
  statement {
    effect = "Allow"
    actions = [
      "ec2:RebootInstances"
    ]
    resources = ["*"]
  }
}

resource "aws_iam_policy" "iam_change_own_password" {
  name        = "${var.project}-${var.environment}-iam-change_own_password-iam-policy"
  description = "IAM Change own password policy"
  policy      = data.aws_iam_policy_document.iam_change_own_password.json
}

data "aws_iam_policy_document" "iam_change_own_password" {
  statement {
    effect = "Allow"
    actions = [
      "iam:ChangePassword"
    ]
    #è‡ªåˆ†è‡ªèº«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹
    resources = ["arn:aws:iam::*:user/$${aws:username}"]
  }
}

```

## IAMã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
- å…¨ãƒªã‚½ãƒ¼ã‚¹èª­ã¿å–ã‚Šè¨±å¯ : AWSç®¡ç†ãƒãƒªã‚·ãƒ¼`ReadOnlyAccess`
- ãƒ“ãƒªãƒ³ã‚°ã®æ‹’å¦ : ä¸Šè¨˜ã§ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼
- EC2å†èµ·å‹•ã®è¨±å¯ : ä¸Šè¨˜ã§ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã®è¨±å¯ : ä¸Šè¨˜ã§ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼

```HCL:iam_group.tf
# ---------------------------------------------
# IAM Group
# ---------------------------------------------

resource "aws_iam_group" "developers" {
  name = "developers"
}

resource "aws_iam_group_policy_attachment" "developers_readonly_policy" {
  group      = aws_iam_group.developers.name
  policy_arn = "arn:aws:iam::aws:policy/ReadOnlyAccess"
}

resource "aws_iam_group_policy_attachment" "developers_billing_deny" {
  group      = aws_iam_group.developers.name
  policy_arn = aws_iam_policy.billing_deny.arn
}

resource "aws_iam_group_policy_attachment" "developers_ec2_rebootable" {
  group      = aws_iam_group.developers.name
  policy_arn = aws_iam_policy.ec2_rebootable.arn
}

resource "aws_iam_group_policy_attachment" "developers_iam_change_own_password" {
  group      = aws_iam_group.developers.name
  policy_arn = aws_iam_policy.iam_change_own_password.arn
}
```

## GPGã‚’ä½¿ã£ãŸæš—å·/å¾©å·
- masterã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆ
    - RSA 2048bit
    - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—
- ä»»æ„æ–‡å­—ã‚’æš—å·åŒ–
- æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·

### GPGã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
$ brew install gpg
```

### éµã®ä½œæˆ
```
$ gpg --gen-key
```
### éµã®ç¢ºèª
```
$ gpg --list-keys
```
ã“ã“ã§å‡ºã¦ãã‚‹`uid`ã‚’æ¬¡ã§ä½¿ç”¨ã€‚
### 

### ç§˜å¯†éµã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
```
$ gpg -o master.public.pgp --export ä¸Šè¨˜ã®uid
```
certã«ç§»å‹•ã•ã›ã¦ãŠãã€‚

## IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
```HCL:main.tf
variable "user_name" {
  type = string
}
```
```HCL:terraform.tfvars
user_name = "testname"
```
```HCL:iam_user.tf
# ---------------------------------------------
# IAM User
# ---------------------------------------------
resource "aws_iam_user" "user" {
  name = var.user_name
  force_destroy = true
}

resource "aws_iam_user_group_membership" "developers" {
  user = aws_iam_user.user.name
  groups = [ aws_iam_group.developers.name ]
}

resource "aws_iam_user_login_profile" "login_profile" {
  user = aws_iam_user.user.name
  pgp_key = filebase64("å…ˆã»ã©ä½œã£ãŸmasterã‚­ãƒ¼ã®ãƒ‘ã‚¹")
  password_length = 20
  password_reset_required = true
}

output "password" {
    value = aws_iam_user_login_profile.login_profile.encrypted_password
}
```

- applyå¾Œã«outputsã§æš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- password.txtãªã©ã«ä¿å­˜ã—ã¦ãŠã
- ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ã‚¯ãƒªãƒ—ãƒˆ
```
$ cat password.txt | base64 -d | gpg -r master --decrypt
```
- è¡¨ç¤ºã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¦ãŠã