---
title: "ã€Terraformã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ"
emoji: "ğŸŒŠ"
type: "tech"
topics:
  - "aws"
  - "s3"
  - "terraform"
published: true
published_at: "2025-01-11 23:25"
---

## ã¯ã˜ã‚ã«
Terraformã§ä¸‹è¨˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c333303de1e0-20250111.png)
VCPãªã©ã¯å‰å›ã®ç¶šãã§ã™ã€‚
https://zenn.dev/t_oishi/articles/c92f6a352ffa22

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ 
```
.
â”œâ”€â”€ main.tf
â”œâ”€â”€ network.tf
â”œâ”€â”€ security_group.tf
â””â”€â”€ terraform.tfvarsã€
```
## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
ä¸‹è¨˜ï¼’ã¤ã‚’è¨­å®šã€‚
### aws_security_group
1. name : string : ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å
2. descriptioon : string : èª¬æ˜
3. vpc_id : string : VPC ID
4. tags : object : ã‚¿ã‚°
### aws_security_group_rule
1. security_group_id : string : ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID
2. type : enum : ingreee,egress
3. protocol : enum : tcp,udp,icmpãªã©
4. from_port : number : é–‹å§‹ãƒãƒ¼ãƒˆç•ªå·ã¾ãŸã¯é–‹å§‹ICMPã‚¿ã‚¤ãƒ—ç•ªå·
5. to_port : number : çµ‚äº†ãƒãƒ¼ãƒˆç•ªå·ã¾ãŸã¯çµ‚äº†ICMPã‚¿ã‚¤ãƒ—ç•ªå·
6. cidr_blocks : string[] : CIDRãƒ–ãƒ­ãƒƒã‚¯
7. source_security_group_id : string : ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã—ãŸã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID


## ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆ
AWSãŒç®¡ç†ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ãƒ³ã‚¸ã®ãƒªã‚¹ãƒˆã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€æœ€æ–°ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ¬ãƒ³ã‚¸ã‚’æ‰‹å‹•ã§æ›´æ–°ã™ã‚‹å¿…è¦ãŒç„¡ããªã‚‹ã€‚
ä¾‹ãˆã°ã€Amazon S3ã‚„CloudFrontç­‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹å ´åˆã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«è¨­å®šãŒå¯èƒ½ã«ãªã‚‹ã€‚

ä»Šå›S3ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€data.tfã«ãã®è¨˜è¿°ã‚’æ›¸ã„ã¦ã„ãã€‚
nameã¯S3ã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã§ç¢ºèªã€‚
```HCL:data.tf
data "aws_prefix_list" "s3_pl" {
  name = "com.amazonaws.*.s3"
}
```
applyå¾Œã«terraform.tfstateã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

## security_group.tf
```HCL:security_group.tf
#------------------
#Scurity Group
#------------------
#web security group
resource "aws_security_group" "web_sg" {
  name        = "${var.project}-${var.environment}-web-sg"
  description = "web front role security group"
  vpc_id      = aws_vpc.vpc.id

  tags = {
    Name    = "${var.project}-${var.environment}-web-sg"
    Project = var.project
    Env     = var.environment
  }
}

resource "aws_security_group_rule" "web_in_http" {
  security_group_id = aws_security_group.web_sg.id
  type              = "ingress"
  protocol          = "tcp"
  from_port         = 80
  to_port           = 80
  cidr_blocks       = ["0.0.0.0/0"]
}

resource "aws_security_group_rule" "web_in_https" {
  security_group_id = aws_security_group.web_sg.id
  type              = "ingress"
  protocol          = "tcp"
  from_port         = 443
  to_port           = 443
  cidr_blocks       = ["0.0.0.0/0"]
}

resource "aws_security_group_rule" "web_in_tcp3000" {
  security_group_id        = aws_security_group.web_sg.id
  type                     = "egress"
  protocol                 = "tcp"
  from_port                = 3000
  to_port                  = 3000
  source_security_group_id = aws_security_group.app_sg.id
}

#app security group
resource "aws_security_group" "app_sg" {
  name        = "${var.project}-${var.environment}-app-sg"
  description = "application server role security group"
  vpc_id      = aws_vpc.vpc.id

  tags = {
    Name    = "${var.project}-${var.environment}-app-sg"
    Project = var.project
    Env     = var.environment
  }
}

resource "aws_security_group_rule" "app_in_tcp3000" {
  security_group_id        = aws_security_group.app_sg.id
  type                     = "ingress"
  protocol                 = "tcp"
  from_port                = 3000
  to_port                  = 3000
  source_security_group_id = aws_security_group.web_sg.id
}

resource "aws_security_group_rule" "app_out_http" {
  security_group_id = aws_security_group.app_sg.id
  type              = "egress"
  protocol          = "tcp"
  from_port         = 80
  to_port           = 80
  prefix_list_ids   = [data.aws_prefix_list.s3_pl.id]
}

resource "aws_security_group_rule" "app_out_https" {
  security_group_id = aws_security_group.app_sg.id
  type              = "egress"
  protocol          = "tcp"
  from_port         = 443
  to_port           = 443
  prefix_list_ids   = [data.aws_prefix_list.s3_pl.id]
}

resource "aws_security_group_rule" "app_out_tcp3306" {
  security_group_id        = aws_security_group.app_sg.id
  type                     = "egress"
  protocol                 = "tcp"
  from_port                = 3306
  to_port                  = 3306
  source_security_group_id = aws_security_group.db_sg.id
}

#Database security group
resource "aws_security_group" "db_sg" {
  name        = "${var.project}-${var.environment}-db-sg"
  description = "Database role security group"
  vpc_id      = aws_vpc.vpc.id

  tags = {
    Name    = "${var.project}-${var.environment}-db-sg"
    Project = var.project
    Env     = var.environment
  }
}

resource "aws_security_group_rule" "db_in_tcp3306" {
  security_group_id        = aws_security_group.db_sg.id
  type                     = "ingress"
  protocol                 = "tcp"
  from_port                = 3306
  to_port                  = 3306
  source_security_group_id = aws_security_group.app_sg.id
}

```
