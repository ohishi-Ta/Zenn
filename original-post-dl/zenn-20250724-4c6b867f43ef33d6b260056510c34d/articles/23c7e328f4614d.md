---
title: "ã€Amazon Bedrockã€‘Lambdaé–¢æ•°ã‹ã‚‰Bedrockã‚’å‘¼ã³å‡ºã—ã¦LLMã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ˜º"
type: "tech"
topics:
  - "aws"
  - "ai"
  - "bedrock"
  - "react"
published: true
published_at: "2025-07-02 11:54"
---

# ã¯ã˜ã‚ã«
Amazon Bedrock ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªé–‹ç™ºã‚’ã—ãŸã„ã¨æ€ã„ã€ã¾ãšã¯RAGç­‰ã‚’ä½¿ç”¨ã—ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªLLMã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

# æ§‹æˆ
æ§‹æˆå›³ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå½¢ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/1a7913fba5da-20250702.png)

## S3
é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ç½®ç”¨ã§ã™ã€‚Reactã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã‚’ç½®ã„ã¦ã„ã¾ã™ã€‚

## API Gateway
ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’POSTé€ä¿¡ã—ã¦ã„ã¾ã™ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯Lambdaã§ã™ã€‚

## Lambda
å—ã‘å–ã£ãŸå…¥åŠ›å†…å®¹ã‚’ç”¨ã„ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã€Bedrock ã¸é€ä¿¡ã—ã¾ã™ã€‚

## Bedrock
APIã‚’ä»‹ã—ã¦åŸºç›¤ãƒ¢ãƒ‡ãƒ«ï¼ˆFMï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ä»Šå›ã¯ä»¥ä¸‹ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
- åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«
    - Embed Multilingual
- åŸºç›¤ãƒ¢ãƒ‡ãƒ«
    - Claude 3.5 Sonnet

**ç”¨èªã«ã¤ã„ã¦ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**
https://zenn.dev/t_oishi/articles/438e218c7aa0ca

# æº–å‚™
## ãƒ¢ãƒ‡ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®è§£é™¤
ä¸‹è¨˜ã®`ãƒ¢ãƒ‡ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®å¤‰æ›´`ã‹ã‚‰ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸ã—ã¾ã—ã‚‡ã†ã€‚
![](https://storage.googleapis.com/zenn-user-upload/af8fdff679c9-20250702.png)

# å®Ÿè£…
## Lambdaé–¢æ•°
Bedrockã¸ã®IAMãƒ­ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚
ä»Šå›ã¯`AmazonBedrockFullAccess`ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```python
import json
import boto3

# Bedrockã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
bedrock_runtime = boto3.client(service_name='bedrock-runtime', region_name='ap-northeast-1')

def lambda_handler(event, context):
    try:
        # API Gatewayã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
        body = json.loads(event['body'])
        user_prompt = body['prompt']

        # Claude 3.5 Sonnetã«æ¸¡ã™ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
        prompt_config = {
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": 1024,
            "messages": [
                {
                    "role": "user",
                    "content": [{"type": "text", "text": user_prompt}]
                }
            ]
        }
        
        # Bedrockã§ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã™
        response = bedrock_runtime.invoke_model(
            body=json.dumps(prompt_config),
            modelId='anthropic.claude-3-5-sonnet-20240620-v1:0',
            accept='application/json',
            contentType='application/json'
        )
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’ãƒ‘ãƒ¼ã‚¹
        response_body = json.loads(response.get('body').read())
        ai_response = response_body['content'][0]['text']
        
        # --- ã“ã“ãŒæœ€é‡è¦ãƒã‚¤ãƒ³ãƒˆ ---
        # API GatewayãŒæœŸå¾…ã™ã‚‹å½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*' # CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¿…ãšå«ã‚ã‚‹
            },
            # Reactå´ãŒ data.body ã§å—ã‘å–ã‚‹ã“ã¨ã‚’æƒ³å®š
            'body': json.dumps(ai_response) 
        }

    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚API Gatewayã®å½¢å¼ã§è¿”ã™
        print(e) # CloudWatchã§ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«printã™ã‚‹
        return {
            'statusCode': 500,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': str(e)})
        }
```

## API Gateway
POSTã§å®Ÿè£…ã—ã¾ã™ã€‚
CORSã®è¨­å®šã‚’å¿˜ã‚Œãšã«ã—ã¾ã—ã‚‡ã†ã€‚
![](https://storage.googleapis.com/zenn-user-upload/a2da5d584d03-20250702.png)

## ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆReactï¼‰
```jsx:App.jsx
import { useState } from 'react';

function App() {
  const [prompt, setPrompt] = useState('');
  const [response, setResponse] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!prompt) return;

    // --- [LOG 1] ---
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãŒé–‹å§‹ã•ã‚ŒãŸã“ã¨ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    console.log('ğŸš€ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹...');
    
    setIsLoading(true);
    setResponse('');
    setError('');

    try {
      const apiEndpoint = 'API Gatewayã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ';
      const requestBody = { prompt: prompt };

      // --- [LOG 2] ---
      // ã©ã®URLã«ã€ã©ã‚“ãªãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ã®ã‹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
      console.log(`ğŸ“¡ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡:
      - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${apiEndpoint}
      - ãƒ¡ã‚½ãƒƒãƒ‰: POST
      - ãƒœãƒ‡ã‚£:`, requestBody);

      const res = await fetch(apiEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
      });

      // --- [LOG 3] ---
      // APIã‹ã‚‰ã®ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ã‚°ã«å‡ºåŠ›
      console.log('ğŸ“¬ APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', res);

      if (!res.ok) {
        // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
        throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${res.status} ${res.statusText}`);
      }

      const data = await res.json();
      
      // --- [LOG 4] ---
      // JSONãƒ‘ãƒ¼ã‚¹å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆã“ã‚ŒãŒæœ€çµ‚çš„ãªå¿œç­”ãƒ‡ãƒ¼ã‚¿ï¼‰
      console.log('âœ… å¿œç­”ãƒ‡ãƒ¼ã‚¿:', data);

      setResponse(data);

    } catch (err) {
      // --- [LOG 5] ---
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãã®å†…å®¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡ºåŠ›
      console.error('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', err);
      setError(err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');

    } finally {
      // --- [LOG 6] ---
      // å‡¦ç†ãŒå®Œäº†ã—ãŸã“ã¨ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
      console.log('ğŸ å‡¦ç†å®Œäº†');
      setIsLoading(false);
    }
  };

  return (
    <div className="bg-gray-100 min-h-screen flex items-center justify-center p-4">
      <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 className="text-3xl font-bold text-center text-gray-800 mb-2">
          Chat with Claude 3.5 Sonnet
        </h1>

        <form onSubmit={handleSubmit}>
          <textarea
            value={prompt}
            onChange={(e) => setPrompt(e.target.value)}
            placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
            className="w-full h-32 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
            disabled={isLoading}
          />
          <button
            type="submit"
            disabled={isLoading || !prompt}
            className="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-300"
          >
            {isLoading ? 'é€ä¿¡ä¸­...' : 'POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡'}
          </button>
        </form>

        {(response || error || isLoading) && (
          <div className="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h2 className="text-lg font-semibold text-gray-700 mb-2">å¿œç­”çµæœ</h2>
            {isLoading && <p className="text-gray-600 animate-pulse">AIãŒå¿œç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...</p>}
            {error && <p className="text-red-500 whitespace-pre-wrap">{error}</p>}
            {response && <p className="text-gray-800 whitespace-pre-wrap">{response}</p>}
          </div>
        )}
      </div>
    </div>
  );
}

export default App;
```

# å®Œæˆå›³
![](https://storage.googleapis.com/zenn-user-upload/4750f84e7114-20250702.png)

# ãŠã‚ã‚Šã«
ä»Šå›ã¯RAGã‚’ä½¿ã‚ãªã„ã®ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã—ãŸãŒæ¬¡å›ã¯ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦RAGã‹ã‚‰å›ç­”ã‚’å¾—ã‚‹æ–¹æ³•ã‚„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­å®šç­‰ã‚‚ä½œæˆã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
