---
title: "ã€API Gatewayãƒ»StepFunctionsã€‘APIå‘¼ã³å‡ºã—ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆOriginï¼‰ã«ã‚ˆã£ã¦StepFunctionså†…ã§åˆ†å²ã‚’ã™ã‚‹"
emoji: "ğŸ™"
type: "tech"
topics:
  - "aws"
  - "lambda"
  - "apigateway"
  - "stepfunctions"
published: true
published_at: "2025-07-10 15:04"
---

# ã¯ã˜ã‚ã«
ä»¥ä¸‹ã®æ§‹æˆã®ã‚ˆã†ã«ã€ã€ŒAPIã‚’ãŸãŸããƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚ˆã£ã¦ã€å¾Œç¶šã®å‡¦ç†ã‚’å¤‰ãˆãŸã„ã€ã¨ã„ã†å®Ÿè£…ã‚’æ¤œè¨¼ã—ãŸã®ã§ã€ãã®æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5aa5fd667dae-20250710.png)

# å®Ÿè£…æ–¹æ³•
å®Ÿè£…æ–¹æ³•è‡ªä½“ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã„ãã¤ã‹é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚
1. Lambdaå†…ã§Originãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
2. API Gatewayãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§Originãƒã‚§ãƒƒã‚¯
3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§å‘¼ã³å‡ºã—æ™‚ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ã€€

ä»Šå›ã¯ã€ãªã‚‹ã¹ãã‚¤ãƒ³ãƒ•ãƒ©å´ã§å‡¦ç†ãŒã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã®ã§ã€**2ç•ª**ã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

# APIGateway
Step Functionsã¸ã®çµ±åˆã®ä»•æ–¹ã¯å‰²æ„›ã—ã¾ã™ã€‚

APIã‚’ä½œæˆã—ãŸã‚‰ã€**çµ±åˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**ã‚’ç·¨é›†ã—ã¦ã„ãã¾ã™ã€‚

å†…å®¹ã¨ã—ã¦ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®`Origin`ã®å†…å®¹ã«ã‚ˆã£ã¦ã€StepFunctionsã«æ¸¡ã™`input`ã«`skipFirstLambda:true`ã‚’ä»˜ä¸ã—ã¦æ¸¡ã—ã¦ã„ã¾ã™ã€‚

StepFunctionsã§ã¯ã“ã®`skipFirstLambda`ã®å€¤ã‚’å‚ç…§ã—ã€åˆ†å²ã‚’ã—ã¾ã™ã€‚

```:VTL
#set($origin = $input.params('Origin'))
#set($escapedBody = $util.escapeJavaScript($input.body))
#if($origin == "https://example.com")
{
  "stateMachineArn": "arn:aws:states:ap-northeast-1:â—â—â—â—â—:stateMachine::â—â—â—â—â—:",
  "input": "{\"skipFirstLambda\": true, \"origin\": \"$origin\", \"body\": $escapedBody}"
}
#else
{
  "stateMachineArn": "arn:aws:states:ap-northeast-1::â—â—â—â—â—::stateMachine::â—â—â—â—â—:", 
    "input": "{\"skipFirstLambda\": false, \"origin\": \"$origin\", \"body\": $escapedBody}"
}
#end
```

## ãƒ†ã‚¹ãƒˆ
ã§ã¯ã€ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ãƒ˜ãƒƒãƒ€ãƒ¼ã«`Origin:https://example.com`ã‚’å…¥åŠ›ã—ã¦ãƒ†ã‚¹ãƒˆã‚’æŠ¼ã—ã¾ã™ã€‚
`skipFirstLambda`ãŒ`true`ã«ãªã£ã¦ã¾ã™ã­ã€‚
![](https://storage.googleapis.com/zenn-user-upload/257f9aefcaa7-20250710.png)

`Origin:https://stg.example.com`ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨å•é¡Œãªãã€`false`ã«ãªã‚Šã¾ã™ã€‚

# Step Functions
ç¶šã„ã¦Step Functionsã®è¨­å®šã‚’ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/eda038b3b8f8-20250710.png)

```:JSONat
{
  "Comment": "A description of my state machine",
  "StartAt": "Choice",
  "States": {
    "Choice": {
      "Type": "Choice",
      "Choices": [
        {
          "Next": "Pass",
          "Condition": "{% $states.input.`skipFirstLambda` = true %}"
        }
      ],
      "Default": "Lambda Invoke-1"
    },
    "Pass": {
      "Type": "Pass",
      "Next": "Lambda Invoke2"
    },
    "Lambda Invoke2": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Output": "{% $states.result.Payload %}",
      "Arguments": {
        "FunctionName": "arn:aws:lambda:ap-northeast-1:â—â—â—â—â—:function:test-lambda:$LATEST",
        "Payload": "{% $states.input %}"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2,
          "JitterStrategy": "FULL"
        }
      ],
      "End": true
    },
    "Lambda Invoke-1": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Output": "{% $states.result.Payload %}",
      "Arguments": {
        "FunctionName": "arn:aws:lambda:ap-northeast-1::â—â—â—â—â—::function:test-lambda:$LATEST",
        "Payload": "{% $states.input %}"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2,
          "JitterStrategy": "FULL"
        }
      ],
      "Next": "Lambda Invoke2"
    }
  },
  "QueryLanguage": "JSONata"
}
```

## ãƒ†ã‚¹ãƒˆ
ã§ã¯ã“ã¡ã‚‰ã‚‚ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
```
{
  "skipFirstLambda":true
}
```
![](https://storage.googleapis.com/zenn-user-upload/d79a15df36a3-20250710.png)

ã—ã£ã‹ã‚Šåˆ†å²ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚
![](https://storage.googleapis.com/zenn-user-upload/0d8c707bcd27-20250710.png)

`false`ã‚‚è©¦ã—ã¦ã¿ã¾ã™ã€‚
å•é¡Œãªã•ãã†ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/a6c5cc33c3bc-20250710.png)

# ãƒ•ãƒ­ãƒ³ãƒˆå®Ÿè£…
å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ†ã‚¹ãƒˆHTMLã‚’ä½œæˆã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã‚µãƒ³ãƒ—ãƒ«HTMLã¯ä»¥ä¸‹ã§ã™ã€‚

**API Gatewayã§CORSã®è¨­å®šã‚’å¿˜ã‚Œãšã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚**

```
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>API ãƒ†ã‚¹ãƒˆ</title>
</head>
<body>
    <button onclick="callAPI()">APIå‘¼ã³å‡ºã—</button>
    
    <div id="result"></div>

    <script>
        async function callAPI() {
            try {
                const response = await fetch('APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({test: 'test'})
                });
                
                const data = await response.text();
                document.getElementById('result').innerHTML = `<pre>Status: ${response.status}\n${data}</pre>`;
                
            } catch (error) {
                document.getElementById('result').innerHTML = `<pre>Error: ${error}</pre>`;
            }
        }
    </script>
</body>
</html>
```

# ãŠã‚ã‚Šã«
ä»Šå›ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚ˆã£ã¦APIGatewayã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€åˆ†å²ã‚’ã—ã€Step Functionsã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã™ã‚‹æ–¹æ³•ã‚’æ¤œè¨¼ã—ã¦ãã¾ã—ãŸã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®`Origin`ã‚’ä½¿ãˆã°ã€ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã—ãŸã€‚
Lambdaã‚„ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãšã«æ¸ˆã‚€ã®ã§ã€ãƒªã‚½ãƒ¼ã‚¹ã®å½¹å‰²ã‚’æ˜ç¢ºã«åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã€ç®¡ç†ã‚‚ã—ã‚„ã™ããªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚