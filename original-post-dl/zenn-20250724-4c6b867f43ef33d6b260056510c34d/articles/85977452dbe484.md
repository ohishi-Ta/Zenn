---
title: "ã€Terraformã€‘EC2ã¨RDSã§WPã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã‚‹"
emoji: "ğŸŒŸ"
type: "tech"
topics:
  - "aws"
  - "wordpress"
  - "ec2"
  - "terraform"
  - "rds"
published: true
published_at: "2025-01-17 09:23"
---

## ã¯ã˜ã‚ã«
ä¸‹è¨˜ã®æ§‹æˆã‚’Terraformã§ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
- EC2
    - AMI
        - Amazon Linux 2 AMI (HVM) - Kernel 5.10, SSD Volume Type
    - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—
        - t2.micro
- RDS
    - DB
        - Mysql 8.0.40
    - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—
        - t3.micro
    - ãƒãƒ«ãƒAZ
![](https://storage.googleapis.com/zenn-user-upload/3df2d5571ca1-20250116.png)

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
.
â”œâ”€â”€ architecture.drawio
â”œâ”€â”€ ec2.tf
â”œâ”€â”€ keypair.tf
â”œâ”€â”€ main.tf
â”œâ”€â”€ network.tf
â”œâ”€â”€ providers.tf
â”œâ”€â”€ rds.tf
â”œâ”€â”€ securitygroup.tf
â”œâ”€â”€ terraform.tfstate
â”œâ”€â”€ terraform.tfstate.backup
â”œâ”€â”€ terraform.tfvars
â”œâ”€â”€ userdata.sh
â””â”€â”€ variable.tf
```

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š
```HCL:provider.tf
#------------------
# Terraform configuration
#------------------
terraform {
  required_version = ">=1.10"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  profile = "udemy_terraform"
  region  = "ap-northeast-1"
}
```
## tfstateã‚’S3ã§ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
- ãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚ªãƒ•ã«ã—ã¦ãŠã
- ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã®ä½œæˆï¼ˆãƒãƒªã‚·ãƒ¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
- ãƒ–ãƒ­ãƒƒã‚¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚ªãƒ³ã«ã—ã¦ãŠã
- terraformãƒ–ãƒ­ãƒƒã‚¯ã«backendå±æ€§ã‚’è¿½åŠ 
- `terraform init`ã§åˆæœŸåŒ–
```HCL:provider.tf
#------------------
# Terraform configuration
#------------------
terraform {
  backend "s3" {
    bucket  = "terraform-wp-dev-tfstate"
    region  = "ap-northeast-1"
    key     = "terraform.tfstate"
    profile = "udemy_terraform"
  }
}
```
## VPCä½œæˆ
```HCL:network.tf
#------------------
# VPC
#------------------
resource "aws_vpc" "vpc" {
  cidr_block                       = "10.0.0.0/24"
  instance_tenancy                 = "default"
  enable_dns_hostnames             = true
  enable_dns_support               = true
  assign_generated_ipv6_cidr_block = false

  tags = {
    Name    = "${var.project}-${var.environment}-vpc"
    Project = var.project
    Env     = var.environment
  }
}
```

## ã‚µãƒ–ãƒãƒƒãƒˆã®ä½œæˆ
```HCL:network.tf
#------------------
# Subnet
#------------------
resource "aws_subnet" "public-subnet-1a" {
  vpc_id                  = aws_vpc.vpc.id
  availability_zone       = "ap-northeast-1a"
  cidr_block              = "10.0.1.0/24"
  map_public_ip_on_launch = true
  tags = {
    Name    = "${var.project}-${var.environment}-public-subnet-1a"
    Project = var.project
    Env     = var.environment
    Type    = "public"
  }
}

resource "aws_subnet" "private-subnet-1a" {
  vpc_id                  = aws_vpc.vpc.id
  availability_zone       = "ap-northeast-1a"
  cidr_block              = "10.0.2.0/24"
  map_public_ip_on_launch = false
  tags = {
    Name    = "${var.project}-${var.environment}-private-subnet-1a"
    Project = var.project
    Env     = var.environment
    Type    = "private"
  }
}

resource "aws_subnet" "private-subnet-1c" {
  vpc_id                  = aws_vpc.vpc.id
  availability_zone       = "ap-northeast-1c"
  cidr_block              = "10.0.3.0/24"
  map_public_ip_on_launch = false
  tags = {
    Name    = "${var.project}-${var.environment}-private-subnet-1c"
    Project = var.project
    Env     = var.environment
    Type    = "private"
  }
}
```

## ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã¨ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
```HCL:network.tf
#------------------
# internet gateway
#------------------
resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.vpc.id
  tags = {
    Name    = "${var.project}-${var.environment}-igw"
    Project = var.project
    Env     = var.environment
  }
}

#------------------
# Route table
#------------------
resource "aws_route_table" "rt" {
  vpc_id = aws_vpc.vpc.id
  tags = {
    Name    = "${var.project}-${var.environment}-rt"
    Project = var.project
    Env     = var.environment
  }
}

resource "aws_route" "route" {
  route_table_id         = aws_route_table.rt.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_internet_gateway.igw.id
}

resource "aws_route_table_association" "rt-public-1a" {
  route_table_id = aws_route_table.rt.id
  subnet_id      = aws_subnet.public-subnet-1a.id
}
```
## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
```HCL:securitygroup.tf
#------------------
# Security Group
#------------------
resource "aws_security_group" "app-sg" {
  name        = "app-sg"
  description = "Webserver security group"
  vpc_id      = aws_vpc.vpc.id
  tags = {
    Name    = "${var.project}-${var.environment}-app-sg"
    Project = var.project
    Env     = var.environment
  }
}

resource "aws_security_group" "db-sg" {
  name        = "db-sg"
  description = "DBserver security group"
  vpc_id      = aws_vpc.vpc.id
  tags = {
    Name    = "${var.project}-${var.environment}-db-sg"
    Project = var.project
    Env     = var.environment
  }
}

resource "aws_security_group_rule" "app-ssh" {
  security_group_id = aws_security_group.app-sg.id
  type              = "ingress"
  from_port         = "22"
  to_port           = "22"
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
}

resource "aws_security_group_rule" "app-http" {
  security_group_id = aws_security_group.app-sg.id
  type              = "ingress"
  from_port         = "80"
  to_port           = "80"
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
}

resource "aws_security_group_rule" "app-all" {
  security_group_id = aws_security_group.app-sg.id
  type              = "egress"
  from_port         = 0
  to_port           = 0
  protocol          = "-1"
  cidr_blocks       = ["0.0.0.0/0"]
}


resource "aws_security_group_rule" "app-mysql" {
  security_group_id        = aws_security_group.app-sg.id
  type                     = "egress"
  from_port                = "3306"
  to_port                  = "3306"
  protocol                 = "tcp"
  source_security_group_id = aws_security_group.db-sg.id
}

resource "aws_security_group_rule" "db-tcp" {
  security_group_id        = aws_security_group.db-sg.id
  type                     = "ingress"
  from_port                = "3306"
  to_port                  = "3306"
  protocol                 = "tcp"
  source_security_group_id = aws_security_group.app-sg.id
}
```

## RDSã®ä½œæˆ
ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã§ä½œæˆã—ã¾ã—ãŸã€‚
```HCL:rds.tf
#------------------
# RDS
#------------------
resource "aws_db_subnet_group" "mysql-subnetgroup" {
  name        = "${var.project}-${var.environment}-mysql-subnetgroup"
  description = "DB Subnet Group"
  subnet_ids  = [aws_subnet.private-subnet-1a.id, aws_subnet.private-subnet-1c.id]
  tags = {
    Name    = "${var.project}-${var.environment}-mysql-subnetgroup"
    Project = var.project
    Env     = var.environment
  }
}


resource "aws_db_instance" "mysql_db" {
  #åŸºæœ¬è¨­å®š
  engine         = "mysql"
  engine_version = "8.0.40"

  identifier = "${var.project}-${var.environment}-mysql"

  username = var.db_username
  password = var.db_password

  instance_class = "db.t3.micro"

  #ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
  allocated_storage     = 20
  max_allocated_storage = 50
  storage_type          = "gp2"
  storage_encrypted     = false

  #ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
  multi_az               = true
  db_subnet_group_name   = aws_db_subnet_group.mysql-subnetgroup.name
  vpc_security_group_ids = [aws_security_group.db-sg.id]
  publicly_accessible    = false
  port                   = 3306

  #DBè¨­å®š
  db_name = "wp_terraform_db"

  #ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  backup_window              = "04:00-05:00"
  backup_retention_period    = 7
  maintenance_window         = "Mon:05:00-Mon:08:00"
  auto_minor_version_upgrade = false

  #å‰Šé™¤é˜²æ­¢
  deletion_protection = false
  skip_final_snapshot = true

  apply_immediately = true

  tags = {
    Name    = "${var.project}-${var.environment}-mysqldb"
    Project = var.project
    Env     = var.environment
  }
}
```

## EC2ã®ä½œæˆ
```HCL:ec2.tf
#------------------
# EC2
#------------------
data "aws_ami" "app" {
  most_recent = true
  owners      = ["self", "amazon"]

  filter {
    name   = "name"
    values = ["amzn2-ami-kernel-5.10-hvm-2.0.*.0-x86_64-gp2"]
  }

  filter {
    name   = "root-device-type"
    values = ["ebs"]
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}


#------------------
#EC2 Instance
#------------------
resource "aws_instance" "app_server" {
  #åŸºæœ¬è¨­å®š
  ami           = data.aws_ami.app.id
  instance_type = "t2.micro"
  #ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
  subnet_id                   = aws_subnet.public-subnet-1a.id
  associate_public_ip_address = true
  vpc_security_group_ids      = [aws_security_group.app-sg.id]
  #ãã®ä»–
  key_name  = aws_key_pair.keypair.key_name
  user_data = file("./userdata.sh")

  tags = {
    Name    = "${var.project}-${var.environment}-app-ec2"
    Project = var.project
    Env     = var.environment
    Type    = "app"
  }

}

```

```sh:userdata.sh
#!/bin/bash
yum update -y

##php
amazon-linux-extras install php7.2 -y
yum -y install mysql httpd php-mbstring php-xml

##wp
wget http://ja.wordpress.org/latest-ja.tar.gz -P /tmp/
tar zxvf /tmp/latest-ja.tar.gz -C /tmp
cp -r /tmp/wordpress/* /var/www/html/

## Apacheã€€Setup
chown -R apache:apache /var/www/html
systemctl start httpd
systemctl enable httpd
```

## EC2ã«sshæ¥ç¶š
1. ã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆã—ã€é©åˆ‡ãªãƒ•ã‚©ãƒ«ãƒ€ã«æ ¼ç´
```
$ ssh-keygen -t rsa -b 2048 -f ä½œæˆã—ãŸã„éµã®åå‰
```
2. ã‚­ãƒ¼ãƒšã‚¢ã‚’ç™»éŒ²
```HCL:keypair.tf
resource "aws_key_pair" "keypair" {
  key_name   = "${var.project}-${var.environment}-keypair"
  public_key = file("pubã‚­ãƒ¼ã‚’ç½®ã„ãŸãƒ‘ã‚¹")
  tags = {
    Name = "${var.project}-${var.environment}-keypair"
  }
}
```
3. sshæ¥ç¶š
```
$ ssh -i ç§˜å¯†éµã®ãƒ‘ã‚¹ ec2-user@ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP
```
4. userdata.shã®å†…å®¹ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## WPã®è¨­å®š
ä¸‹è¨˜ã§RDSã®å†…å®¹ã‚’è¨­å®šã€‚
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å : RDSã§è¨­å®šã—ãŸ`db_name`
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å : RDSã§è¨­å®šã—ãŸ`username`
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ : RDSã§è¨­å®šã—ãŸ`password`
- ãƒ›ã‚¹ãƒˆå : RDSã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆã€œ.ap-northeast-1.rds.amazonaws.comï¼‰


## æˆåŠŸï¼
![](https://storage.googleapis.com/zenn-user-upload/0e2a69d5b2b7-20250117.png)

### æ„Ÿæƒ³
- ä¸€ã‹ã‚‰è‡ªåˆ†ã§ä½œæˆã—ã¦ã¿ã‚‹ã“ã¨ã§ç†è§£ãŒæ·±ã¾ã£ãŸï¼
- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãŒè§£æ”¾ã•ã‚Œã¦ã„ãªã‹ã£ãŸç‚ºã€ec2.tfã®userdata.shãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚
- moduleã‚„outputãªã©ã‚’ä½¿ç”¨ã—ã€åŠ¹ç‡çš„ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã„ããŸã„ã€‚