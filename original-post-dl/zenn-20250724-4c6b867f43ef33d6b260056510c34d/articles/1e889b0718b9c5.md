---
title: "React + AWS Cognito ã§è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ’¨"
topics: []
published: false
---

## ã¯ã˜ã‚ã«

SPAã§AWS Cognitoã‚’ä½¿ã£ãŸèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã¨ã€å¿…ãšç›´é¢ã™ã‚‹ã®ãŒã€Œãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™åˆ‡ã‚Œã€å•é¡Œã§ã™ã€‚

**ã“ã‚“ãªçµŒé¨“ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ**

- ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦5åˆ†å¾Œã€å±¥æ­´ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨çªç„¶401ã‚¨ãƒ©ãƒ¼
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæ¥­ä¸­ã«çªç„¶ã€Œèªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ã‚’é•·ãè¨­å®šã—ãŸã„ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå¿ƒé…

æœ¬è¨˜äº‹ã§ã¯ã€å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã§é­é‡ã—ãŸã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã—ãŸã€**å®Ÿç”¨çš„ãªãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ‰‹æ³•**ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

## å•é¡Œã®æœ¬è³ªã‚’ç†è§£ã™ã‚‹

### ãªãœãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ‡ã‚Œã‚‹ã®ã‹ï¼Ÿ

AWS Cognitoã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã«æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã§ãã¾ã™ï¼š

```
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: 1æ™‚é–“ã€œ24æ™‚é–“
IDãƒˆãƒ¼ã‚¯ãƒ³: 1åˆ†ã€œ24æ™‚é–“
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³: 1æ—¥ã€œ10å¹´
```

ã—ã‹ã—ã€**SPAï¼ˆSingle Page Applicationï¼‰ã®ç‰¹å¾´**ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ï¼š

1. **ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãŒãªã„**ï¼šå¾“æ¥ã®Webã‚¢ãƒ—ãƒªã¨é•ã„ã€ãƒšãƒ¼ã‚¸é·ç§»ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ©Ÿä¼šãŒãªã„
2. **éåŒæœŸAPIå‘¼ã³å‡ºã—**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«å¿œã˜ã¦APIã‚’å‘¼ã³å‡ºã™ãŸã‚ã€ã„ã¤ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ‡ã‚Œã‚‹ã‹äºˆæ¸¬å›°é›£
3. **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ã®ã‚¿ãƒ–ã‚’è¦‹ã¦ã„ã‚‹é–“ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ‡ã‚Œã‚‹

### å®Ÿéš›ã«èµ·ããŸå•é¡Œ

ç§ãŸã¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ã€ä»¥ä¸‹ã®è¨­å®šã§é‹ç”¨ã—ã¦ã„ã¾ã—ãŸï¼š

```
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: 5åˆ†
IDãƒˆãƒ¼ã‚¯ãƒ³: 5åˆ†
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³: 14æ—¥
```

**çµæœï¼š**
- ãƒšãƒ¼ã‚¸æ›´æ–°å¾Œã€5åˆ†æ”¾ç½®
- å±¥æ­´é¸æŠã§APIå‘¼ã³å‡ºã—
- **401 Unauthorized ã‚¨ãƒ©ãƒ¼**

## è§£æ±ºç­–ï¼šè‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 

### åŸºæœ¬çš„ãªæˆ¦ç•¥

1. **å®šæœŸçš„ãªãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯**ï¼šãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®šæœŸçš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèª
2. **ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥**ï¼šæœŸé™åˆ‡ã‚Œ**å‰**ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°
3. **é€éçš„ãªå‡¦ç†**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ°—ã¥ã‹ã‚Œãªã„ã‚ˆã†ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ

### å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
AuthContext (èªè¨¼ç®¡ç†)
â”œâ”€â”€ å®šæœŸãƒã‚§ãƒƒã‚¯ (setInterval)
â”œâ”€â”€ ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ (validateAndRefreshToken)
â”œâ”€â”€ è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ (refreshTokens)
â””â”€â”€ localStorageç®¡ç†

ChatPage (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)
â”œâ”€â”€ getCurrentToken() - æœ€æ–°ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
â””â”€â”€ APIå‘¼ã³å‡ºã—æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨
```

## å®Ÿè£…ã®è©³ç´°

### 1. AuthContext ã®è¨­è¨ˆ

ã¾ãšã€èªè¨¼ç®¡ç†ã®ä¸­æ ¸ã¨ãªã‚‹AuthContextã‚’å®Ÿè£…ã—ã¾ã™ï¼š

```typescript
// AuthContext.tsx
import React, { createContext, useContext, useState, useEffect } from 'react';

interface User {
  email?: string;
  id_token?: string;
  access_token?: string;
  refresh_token?: string;
  profile: {
    email?: string;
  };
}

interface AuthContextType {
  isAuthenticated: boolean;
  isLoading: boolean;
  user: User | null;
  error: Error | null;
  signinRedirect: () => void;
  removeUser: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [user, setUser] = useState<User | null>(null);
  const [error, setError] = useState<Error | null>(null);

  const cognitoDomain = import.meta.env.VITE_APP_COGNITO_DOMAIN;
  const clientId = import.meta.env.VITE_APP_COGNITO_CLIENT_ID;
  const redirectUri = import.meta.env.VITE_APP_REDIRECT_URI;
```

### 2. å®šæœŸãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ 

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼šuseEffectã®ä¾å­˜é–¢ä¿‚**

```typescript
  useEffect(() => {
    const checkAuth = async () => {
      // åˆæœŸèªè¨¼ãƒã‚§ãƒƒã‚¯å‡¦ç†
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
          // èªè¨¼ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
          const tokenResponse = await exchangeCodeForToken(code);
          if (tokenResponse) {
            const userInfo = decodeIdToken(tokenResponse.id_token);
            const userData: User = {
              email: userInfo.email,
              id_token: tokenResponse.id_token,
              access_token: tokenResponse.access_token,
              refresh_token: tokenResponse.refresh_token,
              profile: { email: userInfo.email }
            };
            
            localStorage.setItem('user', JSON.stringify(userData));
            setUser(userData);
            setIsAuthenticated(true);
            
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        } else {
          // localStorage ã‹ã‚‰èªè¨¼çŠ¶æ…‹ã‚’å¾©å…ƒ
          const storedUser = localStorage.getItem('user');
          if (storedUser) {
            const userData = JSON.parse(storedUser);
            const isValid = await validateAndRefreshToken(userData);
            if (isValid) {
              setUser(userData);
              setIsAuthenticated(true);
            } else {
              localStorage.removeItem('user');
            }
          }
        }
      } catch (err) {
        console.error('èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
        setError(err as Error);
      } finally {
        setIsLoading(false);
      }
    };

    checkAuth();

    // ğŸ”‘ é‡è¦ï¼šå®šæœŸçš„ãªãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯
    const tokenCheckInterval = setInterval(async () => {
      const storedUser = localStorage.getItem('user');
      if (storedUser) {
        const userData = JSON.parse(storedUser);
        const isValid = await validateAndRefreshToken(userData);
        if (!isValid) {
          await removeUser();
        }
      }
    }, 12 * 60 * 60 * 1000); // 12æ™‚é–“ã”ã¨

    return () => {
      clearInterval(tokenCheckInterval);
    };
  }, []); // ğŸ”‘ é‡è¦ï¼šç©ºã®ä¾å­˜é…åˆ—ã§ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²ã
```

### 3. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥

**æ ¸å¿ƒã¨ãªã‚‹é–¢æ•°ï¼švalidateAndRefreshToken**

```typescript
  const validateAndRefreshToken = async (userData: User): Promise<boolean> => {
    try {
      if (!userData.id_token) return false;

      const tokenPayload = decodeIdToken(userData.id_token);
      const currentTime = Math.floor(Date.now() / 1000);
      
      // ğŸ”‘ é‡è¦ï¼šæœŸé™åˆ‡ã‚Œ2æ™‚é–“å‰ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      if (tokenPayload.exp && (tokenPayload.exp <= currentTime + 7200)) {
        if (userData.refresh_token) {
          const refreshedTokens = await refreshTokens(userData.refresh_token);
          if (refreshedTokens) {
            // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            const updatedUser = {
              ...userData,
              id_token: refreshedTokens.id_token,
              access_token: refreshedTokens.access_token,
              refresh_token: refreshedTokens.refresh_token || userData.refresh_token,
            };
            
            localStorage.setItem('user', JSON.stringify(updatedUser));
            setUser(updatedUser);
            return true;
          }
        }
        return false;
      }
      
      return true;
    } catch (error) {
      console.error('ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
      return false;
    }
  };
```

### 4. Cognitoã¨ã®é€šä¿¡

```typescript
  const refreshTokens = async (refreshToken: string) => {
    try {
      const tokenEndpoint = `${cognitoDomain}/oauth2/token`;
      
      const params = new URLSearchParams({
        grant_type: 'refresh_token',
        client_id: clientId,
        refresh_token: refreshToken,
      });

      const response = await fetch(tokenEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString(),
      });

      if (!response.ok) {
        const errorData = await response.text();
        console.error('ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼:', errorData);
        throw new Error(`ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ã«å¤±æ•—: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  };
```

### 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã®åˆ©ç”¨

**ChatPage ã§ã®å®Ÿè£…ä¾‹**

```typescript
// ChatPage.tsx
function ChatPage() {
  const auth = useAuth();
  
  // ğŸ”‘ é‡è¦ï¼šæœ€æ–°ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  const getCurrentToken = () => {
    const storedUser = localStorage.getItem('user');
    if (storedUser) {
      try {
        const userData = JSON.parse(storedUser);
        return userData.id_token;
      } catch (error) {
        console.error('localStorage parsing error:', error);
        localStorage.removeItem('user');
      }
    }
    return null;
  };

  // APIå‘¼ã³å‡ºã—ä¾‹
  const fetchChatHistory = async (chatId: string) => {
    const currentToken = getCurrentToken();
    if (!currentToken) {
      console.error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“');
      return;
    }

    try {
      const response = await fetch(`${apiBaseUrl}/chats/${chatId}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${currentToken}` }
      });

      if (!response.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
      const messages = await response.json();
      // å‡¦ç†ç¶šè¡Œ...
    } catch (error) {
      console.error("ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  };

  // ãã®ä»–ã®APIå‘¼ã³å‡ºã—ã‚‚åŒæ§˜ã«å®Ÿè£…
}
```

## è¨­å®šã®æœ€é©åŒ–

### Cognitoè¨­å®šã®æ¨å¥¨å€¤

æœ¬ç•ªç’°å¢ƒã§ã¯ã€ä»¥ä¸‹ã®è¨­å®šã‚’æ¨å¥¨ã—ã¾ã™ï¼š

```
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: 24æ™‚é–“
IDãƒˆãƒ¼ã‚¯ãƒ³: 24æ™‚é–“
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³: 30æ—¥
```

### å®šæœŸãƒã‚§ãƒƒã‚¯ã®é »åº¦

```typescript
// è¨­å®šã«ã‚ˆã‚‹å®šæœŸãƒã‚§ãƒƒã‚¯é »åº¦ã®èª¿æ•´
const getCheckInterval = (tokenLifetime: number) => {
  if (tokenLifetime <= 5 * 60) return 1 * 60 * 1000;      // 5åˆ†ä»¥ä¸‹ â†’ 1åˆ†ã”ã¨
  if (tokenLifetime <= 60 * 60) return 10 * 60 * 1000;    // 1æ™‚é–“ä»¥ä¸‹ â†’ 10åˆ†ã”ã¨
  if (tokenLifetime <= 24 * 60 * 60) return 12 * 60 * 60 * 1000; // 24æ™‚é–“ä»¥ä¸‹ â†’ 12æ™‚é–“ã”ã¨
  return 24 * 60 * 60 * 1000; // ãã‚Œä»¥ä¸Š â†’ 24æ™‚é–“ã”ã¨
};
```

### ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®èª¿æ•´

```typescript
// ãƒˆãƒ¼ã‚¯ãƒ³å¯¿å‘½ã«å¿œã˜ãŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°
const getRefreshThreshold = (tokenLifetime: number) => {
  if (tokenLifetime <= 5 * 60) return 60;           // 5åˆ†ä»¥ä¸‹ â†’ 1åˆ†å‰
  if (tokenLifetime <= 60 * 60) return 10 * 60;     // 1æ™‚é–“ä»¥ä¸‹ â†’ 10åˆ†å‰
  if (tokenLifetime <= 24 * 60 * 60) return 2 * 60 * 60; // 24æ™‚é–“ä»¥ä¸‹ â†’ 2æ™‚é–“å‰
  return 4 * 60 * 60; // ãã‚Œä»¥ä¸Š â†’ 4æ™‚é–“å‰
};
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

**1. ã€Œ5åˆ†å¾Œã«ã¾ã 401ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€**

**åŸå› ï¼š** AuthContextã®å®šæœŸãƒã‚§ãƒƒã‚¯ãŒå‹•ä½œã—ã¦ã„ãªã„

**è§£æ±ºç­–ï¼š**
```typescript
// useEffectã®ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
useEffect(() => {
  // å‡¦ç†
}, []); // ç©ºã®é…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
```

**2. ã€Œãƒˆãƒ¼ã‚¯ãƒ³ãŒæ›´æ–°ã•ã‚Œãªã„ã€**

**åŸå› ï¼š** ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ¡ä»¶ãŒé©åˆ‡ã§ãªã„

**è§£æ±ºç­–ï¼š**
```typescript
// ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°ã‚’è¿½åŠ 
console.log('ç¾åœ¨æ™‚åˆ»:', new Date());
console.log('ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™:', new Date(tokenPayload.exp * 1000));
console.log('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¿…è¦ï¼Ÿ', tokenPayload.exp <= currentTime + 7200);
```

**3. ã€Œç„¡é™ãƒ«ãƒ¼ãƒ—ãŒç™ºç”Ÿã™ã‚‹ã€**

**åŸå› ï¼š** useEffectã®ä¾å­˜é–¢ä¿‚ã«çŠ¶æ…‹ã‚’å«ã‚ã¦ã„ã‚‹

**è§£æ±ºç­–ï¼š**
```typescript
// âŒ æ‚ªã„ä¾‹
useEffect(() => {
  // å‡¦ç†
}, [isAuthenticated]); // çŠ¶æ…‹å¤‰æ›´ã§ãƒ«ãƒ¼ãƒ—

// âœ… è‰¯ã„ä¾‹
useEffect(() => {
  // å‡¦ç†
}, []); // ç©ºã®é…åˆ—
```

### ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

**1. ãƒˆãƒ¼ã‚¯ãƒ³ã®çŠ¶æ…‹ç¢ºèª**

```typescript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const user = JSON.parse(localStorage.getItem('user'));
const token = user.id_token;
const payload = JSON.parse(atob(token.split('.')[1]));
console.log('ç™ºè¡Œæ™‚åˆ»:', new Date(payload.iat * 1000));
console.log('æœŸé™:', new Date(payload.exp * 1000));
console.log('æœŸé™åˆ‡ã‚Œï¼Ÿ', payload.exp < Date.now() / 1000);
```

**2. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‹•ä½œã®ç¢ºèª**

```typescript
// ä¸€æ™‚çš„ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
const validateAndRefreshToken = async (userData: User): Promise<boolean> => {
  console.log('ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼é–‹å§‹');
  console.log('ğŸ“… ç¾åœ¨æ™‚åˆ»:', new Date());
  console.log('ğŸ“… æœŸé™:', new Date(tokenPayload.exp * 1000));
  
  if (tokenPayload.exp && (tokenPayload.exp <= currentTime + 7200)) {
    console.log('ğŸ”„ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Ÿè¡Œ');
    // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†
  }
  
  return true;
};
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚³ã‚¹ãƒˆè€ƒæ…®

### Cognitoã®æ–™é‡‘ä½“ç³»

- **ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥**: ç„¡æ–™
- **åˆå›èªè¨¼**: 0.0055USD/MAU
- **å®šæœŸãƒã‚§ãƒƒã‚¯**: API Gatewayç­‰ã®é–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯å½±éŸ¿ãªã—

### æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ

1. **å®šæœŸãƒã‚§ãƒƒã‚¯ã®é »åº¦ã‚’é©åˆ‡ã«è¨­å®š**
2. **ä¸è¦ãªãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’é¿ã‘ã‚‹**
3. **localStorage ã®åŠ¹ç‡çš„ãªä½¿ç”¨**

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜

```typescript
// âœ… æ¨å¥¨ï¼šlocalStorage (HTTPSç’°å¢ƒã§ã®ä½¿ç”¨)
localStorage.setItem('user', JSON.stringify(userData));

// âŒ éæ¨å¥¨ï¼šsessionStorage (ã‚¿ãƒ–ã‚¯ãƒ­ãƒ¼ã‚ºã§æ¶ˆå¤±)
// âŒ éæ¨å¥¨ï¼šCookie (CSRFæ”»æ’ƒã®ãƒªã‚¹ã‚¯)
```

### 2. ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™è¨­å®š

```typescript
// ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè¨­å®šä¾‹
const RECOMMENDED_SETTINGS = {
  accessToken: 24 * 60 * 60,      // 24æ™‚é–“
  idToken: 24 * 60 * 60,          // 24æ™‚é–“
  refreshToken: 30 * 24 * 60 * 60, // 30æ—¥
};
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
const handleAuthError = (error: Error) => {
  // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—æ™‚ã¯è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  if (error.message.includes('refresh')) {
    auth.removeUser();
    auth.signinRedirect();
  }
};
```

## ã¾ã¨ã‚

æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®åŠ¹æœãŒå¾—ã‚‰ã‚Œã¾ã™ï¼š

âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š**ï¼šèªè¨¼ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹ä¸­æ–­ãŒãªããªã‚‹
âœ… **é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Š**ï¼šèªè¨¼é–¢é€£ã®ãƒã‚°ãŒæ¿€æ¸›
âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç¶­æŒ**ï¼šçŸ­ã„æœ‰åŠ¹æœŸé™ã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã‚’æãªã‚ãªã„
âœ… **é‹ç”¨ã‚³ã‚¹ãƒˆã®å‰Šæ¸›**ï¼šã‚µãƒãƒ¼ãƒˆå•ã„åˆã‚ã›ãŒæ¸›å°‘

### å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] useEffectã®ä¾å­˜é–¢ä¿‚ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] å®šæœŸãƒã‚§ãƒƒã‚¯ã®é »åº¦ãŒãƒˆãƒ¼ã‚¯ãƒ³å¯¿å‘½ã«é©ã—ã¦ã„ã‚‹
- [ ] ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°ãŒæœ¬ç•ªç’°å¢ƒã§å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã€SPAã§ã®èªè¨¼å•é¡Œã‚’æ ¹æœ¬çš„ã«è§£æ±ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦å¿«é©ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚




![](https://storage.googleapis.com/zenn-user-upload/2f50d1777868-20250717.png)
![](https://storage.googleapis.com/zenn-user-upload/d3ad10aad44e-20250717.png)