name: Upload CSV to Dify RAG

on:
  push:
    branches: [main-actions]
    paths:
      - 'public/articles-index.csv'
  workflow_dispatch:

jobs:
  upload-csv-to-dify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Upload CSV to Dify
      env:
        DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
        DIFY_API_URL: ${{ secrets.DIFY_API_URL }}
        DIFY_DATASET_ID: ${{ secrets.DIFY_DATASET_ID }}
      run: |
        python << 'EOF'
        import os
        import requests
        import time
        from pathlib import Path
        
        # 設定
        api_key = os.environ['DIFY_API_KEY']
        api_url = os.environ['DIFY_API_URL']
        dataset_id = os.environ['DIFY_DATASET_ID']
        csv_file = 'public/articles-index.csv'
        
        headers = {
            'Authorization': f'Bearer {api_key}'
        }
        
        print(f"🚀 Uploading {csv_file} to Dify RAG...")
        print(f"   API URL: {api_url}")
        print(f"   Dataset ID: {dataset_id}")
        
        # CSVファイルの存在確認
        if not Path(csv_file).exists():
            print(f"❌ CSV file not found: {csv_file}")
            exit(1)
        
        # ファイルサイズ確認
        file_size = Path(csv_file).stat().st_size
        print(f"📊 File size: {file_size:,} bytes")
        
        # CSVファイルをアップロード
        try:
            with open(csv_file, 'rb') as f:
                files = {
                    'file': (csv_file, f, 'text/csv')
                }
                
                # メタデータ
                data = {
                    'indexing_technique': 'high_quality',
                    'process_rule': '{"mode":"automatic","rules":{"pre_processing_rules":[{"id":"remove_extra_spaces","enabled":true},{"id":"remove_urls_emails","enabled":false}],"segmentation":{"separator":"\\n","max_tokens":1000}}}',
                    'duplicate_removal': 'true'
                }
                
                url = f"{api_url}/datasets/{dataset_id}/document/create_by_file"
                response = requests.post(url, headers=headers, files=files, data=data)
                
                if response.status_code in [200, 201]:
                    result = response.json()
                    print("✅ Successfully uploaded CSV to Dify!")
                    print(f"   Document ID: {result.get('document', {}).get('id', 'N/A')}")
                    
                    # GitHub Actions サマリー
                    summary_file = os.environ.get('GITHUB_STEP_SUMMARY')
                    if summary_file:
                        with open(summary_file, 'w') as sf:
                            sf.write("# 📊 CSV Upload to Dify\n\n")
                            sf.write("| Item | Value |\n")
                            sf.write("|------|-------|\n")
                            sf.write(f"| ✅ Status | Success |\n")
                            sf.write(f"| 📁 File | `{csv_file}` |\n")
                            sf.write(f"| 📊 Size | {file_size:,} bytes |\n")
                            sf.write(f"| 🆔 Document ID | `{result.get('document', {}).get('id', 'N/A')}` |\n")
                            sf.write(f"| 📚 Dataset | `{dataset_id}` |\n")
                            sf.write(f"| 🔗 Commit | `{os.environ.get('GITHUB_SHA', 'unknown')[:7]}` |\n")
                
                else:
                    print(f"❌ Failed to upload CSV")
                    print(f"   Status Code: {response.status_code}")
                    print(f"   Response: {response.text[:500]}")
                    
                    summary_file = os.environ.get('GITHUB_STEP_SUMMARY')
                    if summary_file:
                        with open(summary_file, 'w') as sf:
                            sf.write("# ❌ CSV Upload Failed\n\n")
                            sf.write(f"**Error:** {response.status_code} - {response.text[:200]}\n\n")
                            sf.write(f"**File:** `{csv_file}`\n")
                    
                    exit(1)
                    
        except Exception as e:
            print(f"❌ Error uploading CSV: {str(e)}")
            exit(1)
        
        print("🎉 Upload completed successfully!")
        EOF
